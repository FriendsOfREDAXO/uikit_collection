name: Build UIkit with REDAXO Theme

# Nur manuelles Auslösen des Workflows
on:
  workflow_dispatch:
    inputs:
      uikit_branch:
        description: 'UIkit Branch (main oder 3.x, etc.)'
        required: true
        default: 'main'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Repository auschecken
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
        
      # Node.js einrichten
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      # pnpm installieren
      - name: Install pnpm
        run: |
          npm install -g pnpm
          pnpm --version
          
      # Kopie des lokalen build-uikit.sh in GitHub Actions
      - name: Build UIkit
        run: |
          # Farben für Konsolenausgaben (für GitHub Actions angepasst)
          echo "=== UIkit Build für REDAXO starten (neueste Version) ==="
          
          # Verzeichnisse definieren
          ROOT_DIR="${GITHUB_WORKSPACE}"
          TEMP_DIR="${ROOT_DIR}/temp-uikit"
          UIKIT_VERSION="${{ github.event.inputs.uikit_branch }}"
          
          echo "Root Directory: $ROOT_DIR"
          echo "UIkit Version/Branch: $UIKIT_VERSION"
          
          # Debugging: Zeige die Verzeichnisstruktur
          echo "Aktuelle Verzeichnisstruktur des Repositories:"
          ls -la "${ROOT_DIR}"
          
          # Temporäres Verzeichnis löschen, falls vorhanden
          if [ -d "$TEMP_DIR" ]; then
              echo "Lösche vorhandenes temporäres Verzeichnis..."
              rm -rf "$TEMP_DIR"
          fi
          
          # UIkit Repository klonen
          echo "Klone UIkit Repository..."
          git clone https://github.com/uikit/uikit.git "$TEMP_DIR"
          cd "$TEMP_DIR"
          
          # Versuche den angegebenen Branch zu checken
          if git checkout "$UIKIT_VERSION"; then
            echo "Branch $UIKIT_VERSION erfolgreich ausgecheckt"
          else
            echo "Branch $UIKIT_VERSION nicht gefunden, versuche main und dann master..."
            if git checkout main; then
              echo "Branch main erfolgreich ausgecheckt"
              UIKIT_VERSION="main"
            elif git checkout master; then
              echo "Branch master erfolgreich ausgecheckt" 
              UIKIT_VERSION="master"
            else
              echo "Weder main noch master gefunden. Verwende default Branch."
            fi
          fi
          
          # Hole die aktuelle Version aus package.json
          ACTUAL_VERSION=$(node -p "require('./package.json').version")
          echo "Verwende UIkit Version: ${ACTUAL_VERSION}"
          echo "ACTUAL_VERSION=${ACTUAL_VERSION}" >> $GITHUB_ENV
          
          # Abhängigkeiten installieren
          echo "Installiere Abhängigkeiten..."
          pnpm install
          
          # Debug: Zeige Inhalt des Theme-Ordners
          echo "Inhalt des uikit-theme Verzeichnisses:"
          ls -la "${ROOT_DIR}/uikit-theme"
          
          # Verzeichnis für das angepasste Theme erstellen
          echo "Erstelle angepasstes Theme..."
          mkdir -p custom/redaxo-theme
          cp -r "${ROOT_DIR}/uikit-theme/"* custom/redaxo-theme/
          
          # Erstelle die Hauptdatei für das Theme
          cat > custom/redaxo-theme.less <<EOL
          // Import UIkit core (ohne default theme)
          @import "../src/less/uikit.less";
          
          // Import redaxo-spezifische Anpassungen
          @import "redaxo-theme/_import.less";
          EOL
          
          # UIkit mit angepasstem Theme bauen
          echo "Kompiliere UIkit mit angepasstem Theme..."
          # Bei neueren UIkit Versionen wird pnpm verwendet
          pnpm compile-less
          pnpm compile-js
          
          # Debug: Zeigen, was kompiliert wurde
          echo "Inhalt des dist-Verzeichnisses:"
          ls -la dist/
          ls -la dist/css/
          ls -la dist/js/
          
          # Kompilierte Dateien kopieren - stellen Sie sicher, dass der Pfad korrekt ist
          echo "Kopiere kompilierte Dateien in das assets-Verzeichnis..."
          
          # Stelle sicher, dass wir das richtige assets-Verzeichnis haben
          if [ -d "${ROOT_DIR}/assets" ]; then
            ASSETS_DIR="${ROOT_DIR}/assets"
            echo "Verwende existierendes assets-Verzeichnis: ${ASSETS_DIR}"
          else
            # Erstelle das assets-Verzeichnis, falls es nicht existiert
            ASSETS_DIR="${ROOT_DIR}/assets"
            mkdir -p "${ASSETS_DIR}"
            echo "Erstelle neues assets-Verzeichnis: ${ASSETS_DIR}"
          fi
          
          # Kopiere die kompilierten CSS-Dateien
          mkdir -p "${ASSETS_DIR}/css"
          cp -v dist/css/uikit*.css "${ASSETS_DIR}/css/"
          
          # Kopiere die kompilierten JavaScript-Dateien
          mkdir -p "${ASSETS_DIR}/js"
          cp -v dist/js/uikit*.js "${ASSETS_DIR}/js/"
          
          # Debug: Zeigen, was in assets kopiert wurde
          echo "Inhalt des Assets-Verzeichnisses:"
          ls -la "${ASSETS_DIR}"
          ls -la "${ASSETS_DIR}/css/"
          ls -la "${ASSETS_DIR}/js/"
          
          # Aufräumen
          echo "Räume auf..."
          cd "$ROOT_DIR"
          rm -rf "$TEMP_DIR"
          
          echo "UIkit wurde erfolgreich mit dem REDAXO-Theme gebaut!"
          echo "Die Dateien befinden sich in: ${ASSETS_DIR}"
          echo "Verwendete UIkit Version: ${ACTUAL_VERSION}"
      
      # Artefakte hochladen
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uikit_collection_assets
          path: assets/
      
      # Pull Request erstellen
      - name: Create Pull Request Branch
        run: |
          # Konfiguriere Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Debug: Zeige Status vor dem Commit
          echo "Git Status vor dem Commit:"
          git status
          
          # Prüfe, ob das assets Verzeichnis existiert
          if [ -d "assets" ]; then
            echo "Assets-Verzeichnis gefunden: $(pwd)/assets"
            ls -la assets/
          else
            echo "FEHLER: Assets-Verzeichnis nicht gefunden!"
            echo "Aktuelle Verzeichnisstruktur:"
            find . -type d -maxdepth 3 | sort
            exit 1
          fi
          
          # Neuen Branch erstellen
          BRANCH_NAME="update-uikit-v$ACTUAL_VERSION"
          git checkout -b $BRANCH_NAME
          
          # Überprüfen, ob Änderungen vorhanden sind
          echo "Prüfen, ob assets existieren und Änderungen vorhanden sind:"
          if [ -d "assets" ]; then
            echo "Assets-Verzeichnis gefunden"
            
            # Force add assets, auch wenn sie ignoriert werden
            git add -f assets/
            
            # Debug: Status nach add
            echo "Git Status nach add:"
            git status
            
            # Commit erstellen
            git commit -m "Update UIkit assets to version $ACTUAL_VERSION"
            
            # Debug: Status nach commit
            echo "Git Status nach commit:"
            git status
            
            # Branch pushen (force, um sicherzustellen dass der Branch überschrieben wird)
            git push -f origin $BRANCH_NAME
            
            echo "Branch $BRANCH_NAME erfolgreich gepusht"
            echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          else
            echo "FEHLER: Assets-Verzeichnis nicht gefunden! Build fehlgeschlagen?"
            ls -la
            exit 1
          fi
        
      # Pull Request erstellen
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Update UIkit assets to version ${{ env.ACTUAL_VERSION }}
          title: Update UIkit assets to version ${{ env.ACTUAL_VERSION }}
          body: |
            # UIkit Update
            
            Dieses Update aktualisiert die UIkit-Assets auf Version ${{ env.ACTUAL_VERSION }}.
            
            ## Änderungen:
            - Aktualisierung der CSS-Dateien
            - Aktualisierung der JavaScript-Dateien
            
            Automatisch erstellt durch den GitHub Actions Workflow.
          branch: ${{ env.BRANCH_NAME }}
          base: main
